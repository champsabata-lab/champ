<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAGLACE Master Stock Management v2.0</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,800;1,900&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-pink: #ec4899; --brand-blue: #2563eb; }
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-font-smoothing: antialiased; }
        .animate-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pulse-slow { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        .sidebar-active { background: var(--brand-blue) !important; color: white !important; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.3); transform: scale(1.02); font-weight: 900; }
        .glass-header { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); transition: all 0.3s ease; }
        .card-shadow:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02); }
        .status-pill { padding: 0.375rem 1rem; border-radius: 9999px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid transparent; }
        .status-confirmed { background: #ecfdf5; color: #065f46; border-color: #10b98133; }
        .status-pending { background: #fffbeb; color: #92400e; border-color: #f59e0b33; }
        .rounded-extreme { border-radius: 2.5rem; }
        .product-img-container { position: relative; overflow: hidden; background: #f1f5f9; }
        .product-img-container img { transition: transform 0.5s ease; }
        .product-img-container:hover img { transform: scale(1.1); }
    </style>

    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.35.0"
      }
    }
    </script>
</head>
<body class="overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        // ==========================================
        // 1. FULL MOCK DATA (MANDATORY)
        // ==========================================

        const PRODUCT_CATEGORIES = [
          '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á (Makeup)', '‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå (Skincare)', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Accessories)',
          '‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏° (Fragrance)', '‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏ô‡∏≤‡∏Ñ‡∏∏‡∏ì (Premiums)', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)'
        ];

        const INITIAL_PRODUCTS = [
          { id: 'P001', sku: 'LG-LIP-G01', name: 'Icy Glaze Gloss #01', unit: '‡∏ä‡∏¥‡πâ‡∏ô', category: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á (Makeup)', unitPrice: 289, stockPurchasing: 150, stockContent: 80, stockInfluencer: 300, stockLive: 1200, stockAffiliate: 850, stockBuffer: 4500, lotNumber: 'LOT2401', mfd: '2024-01-10', exp: '2026-01-10', images: ['https://images.unsplash.com/photo-1586771107445-d3ca888129ff?w=400'] },
          { id: 'P002', sku: 'LG-LIP-G02', name: 'Icy Glaze Gloss #02', unit: '‡∏ä‡∏¥‡πâ‡∏ô', category: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á (Makeup)', unitPrice: 289, stockPurchasing: 120, stockContent: 45, stockInfluencer: 250, stockLive: 950, stockAffiliate: 780, stockBuffer: 3800, lotNumber: 'LOT2401', mfd: '2024-01-10', exp: '2026-01-10', images: ['https://images.unsplash.com/photo-1596462502278-27bfdc4033c8?w=400'] },
          { id: 'P003', sku: 'LG-BLS-B01', name: 'Baebie Blush Pink', unit: '‡∏ä‡∏¥‡πâ‡∏ô', category: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á (Makeup)', unitPrice: 289, stockPurchasing: 500, stockContent: 250, stockInfluencer: 1800, stockLive: 4500, stockAffiliate: 3200, stockBuffer: 12500, lotNumber: 'LOT2403', mfd: '2024-03-05', exp: '2026-03-05', images: ['https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?w=400'] },
          { id: 'P004', sku: 'LG-ACC-M01', name: 'La Glace Mirror Case', unit: '‡∏ä‡∏¥‡πâ‡∏ô', category: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Accessories)', unitPrice: 159, stockPurchasing: 45, stockContent: 20, stockInfluencer: 120, stockLive: 600, stockAffiliate: 400, stockBuffer: 2500, lotNumber: 'ACC23-A', mfd: '2023-11-20', exp: '2028-11-20', images: ['https://images.unsplash.com/photo-1523206489230-c012c64b2b48?w=400'] },
          { id: 'P005', sku: 'LG-SKN-B01', name: 'Melt Away Balm', unit: '‡∏ä‡∏¥‡πâ‡∏ô', category: '‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå (Skincare)', unitPrice: 450, stockPurchasing: 200, stockContent: 85, stockInfluencer: 300, stockLive: 850, stockAffiliate: 600, stockBuffer: 3500, lotNumber: 'SKN24-02', mfd: '2024-02-15', exp: '2026-02-15', images: ['https://images.unsplash.com/photo-1556228720-195a672e8a03?w=400'] }
        ];

        const INITIAL_INFLUENCERS = [
          { id: 'IF1', name: 'Mind N.', platform: 'TikTok/Instagram' },
          { id: 'IF2', name: 'Manee Channel', platform: 'YouTube' },
          { id: 'IF3', name: 'ReviewByPloy', platform: 'Twitter' },
          { id: 'IF4', name: 'Baebie Lover Club', platform: 'Facebook' }
        ];

        const INITIAL_STORES = [
          { id: 'S1', name: 'Watsons', subBranches: ['Siam Paragon', 'Central World', 'EmQuartier'] },
          { id: 'S2', name: '7-Eleven', subBranches: ['Bangna', 'Ladprao', 'Silom'] },
          { id: 'S3', name: 'Beautrium', subBranches: ['Siam Center', 'Mega Bangna'] }
        ];

        const INITIAL_ORDERS = [
          { id: 'ORD-1001', poNumber: 'PO-WATS-S01', source: 'purchasing', targetName: 'Watsons Siam Paragon', items: [{ productId: 'P001', productName: 'Icy Glaze Gloss #01', quantity: 50, unitPrice: 289 }, { productId: 'P003', productName: 'Baebie Blush Pink', quantity: 100, unitPrice: 289 }], totalValue: 43350, status: 'confirmed', requestedAt: '2024-05-10T10:00:00', processedAt: '2024-05-10T14:30:00', purchasingDept: '‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏¢' },
          { id: 'ORD-1002', poNumber: 'IF-MIND-01', source: 'influencer', targetName: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏¢‡∏î‡πå (Mind N.)', items: [{ productId: 'P003', productName: 'Baebie Blush Pink', quantity: 20, unitPrice: 289 }], totalValue: 5780, status: 'pending', requestedAt: '2024-05-12T09:15:00', purchasingDept: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡∏£‡∏ß' },
          { id: 'ORD-1003', poNumber: 'AF-SHOPEE-V1', source: 'affiliate', targetName: 'Shopee Affiliate Team', items: [{ productId: 'P002', productName: 'Icy Glaze Gloss #02', quantity: 150, unitPrice: 289 }], totalValue: 43350, status: 'pending', requestedAt: '2024-05-14T11:00:00', purchasingDept: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ö‡∏á‡∏Å‡πå' },
          { id: 'ORD-1004', poNumber: 'BUF-RESTOCK-01', source: 'buffer', targetName: 'South Warehouse', items: [{ productId: 'P003', productName: 'Baebie Blush Pink', quantity: 500, unitPrice: 289 }], totalValue: 144500, status: 'confirmed', requestedAt: '2024-05-08T08:00:00', processedAt: '2024-05-08T10:00:00', purchasingDept: '‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê' }
        ];

        const INITIAL_ANNOUNCEMENTS = [
          { id: 1, title: '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏™‡πà‡∏á Modern Trade', icon: 'üöö', detail: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á...', color: 'blue', updatedAt: new Date().toISOString() },
          { id: 2, title: '‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ LOT2401', icon: '‚ö†Ô∏è', detail: '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏û‡πá‡∏Ñ‡∏™‡πà‡∏á...', color: 'red', updatedAt: new Date().toISOString() }
        ];

        // ==========================================
        // 2. COMPONENTS
        // ==========================================

        const Sidebar = ({ activeView, setActiveView, currentUser, onLogout, pendingCount }) => (
          <aside className="w-80 bg-white border-r border-slate-200 flex flex-col h-full sticky top-0 z-40 transition-all">
            <div className="p-10">
              <h1 className="text-3xl font-black text-pink-500 italic tracking-tighter flex items-center gap-3">
                <div className="w-10 h-10 bg-pink-500 rounded-2xl flex items-center justify-center text-white text-sm shadow-xl shadow-pink-100">L</div>
                LAGLACE
              </h1>
            </div>
            <nav className="flex-1 px-6 space-y-1 overflow-y-auto pb-6">
              {[
                { id: 'DASHBOARD', icon: 'üìä', label: 'Dashboard' },
                { id: 'INVENTORY', icon: 'üì¶', label: 'Inventory' },
                { id: 'PURCHASING', icon: 'üìÅ', label: 'Purchasing' },
                { id: 'INFLUENCER_DEP', icon: 'ü§≥', label: 'Influencer' },
                { id: 'AFFILIATE_DEP', icon: 'üîó', label: 'Affiliate' },
                { id: 'BUFFER_DEP', icon: 'üõ°Ô∏è', label: 'Buffer Stock' },
                { id: 'WAREHOUSE', icon: 'üè≠', label: 'Fulfillment', badge: pendingCount },
                { id: 'AI_CHAT', icon: 'ü§ñ', label: 'Analyst AI' }
              ].map(item => (
                <button 
                  key={item.id}
                  onClick={() => setActiveView(item.id)}
                  className={`w-full text-left px-5 py-4 rounded-2xl flex items-center justify-between transition-all ${activeView === item.id ? 'sidebar-active' : 'text-slate-500 hover:bg-slate-50 font-bold'}`}
                >
                  <span className="flex items-center gap-4"><span>{item.icon}</span> {item.label}</span>
                  {item.badge > 0 && <span className="bg-amber-500 text-white text-[10px] px-2 py-0.5 rounded-full">{item.badge}</span>}
                </button>
              ))}
            </nav>
            <div className="p-8 bg-slate-50 border-t flex items-center gap-4 group">
              <div className="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 font-black shadow-inner">P</div>
              <div className="flex-1 overflow-hidden">
                <p className="text-xs font-black text-slate-800 truncate">{currentUser.name}</p>
                <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{currentUser.role}</p>
              </div>
              <button onClick={onLogout} className="text-slate-300 hover:text-red-500 transition-colors p-2">‚úï</button>
            </div>
          </aside>
        );

        const DashboardView = ({ orders, products }) => {
          const confirmed = orders.filter(o => o.status === 'confirmed');
          const totalUnits = confirmed.reduce((acc, o) => acc + o.items.reduce((s, i) => s + i.quantity, 0), 0);
          const totalValue = confirmed.reduce((acc, o) => acc + o.totalValue, 0);

          return (
            <div className="space-y-8 animate-in">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                {[
                  { label: 'Units Fulfillment', val: totalUnits.toLocaleString(), color: 'pink' },
                  { label: 'Confirmed GMV', val: '‡∏ø' + totalValue.toLocaleString(), color: 'emerald' },
                  { label: 'Pending Dispatches', val: orders.filter(o => o.status === 'pending').length, color: 'amber' },
                  { label: 'Total Stock Allotment', val: products.reduce((acc, p) => acc + p.stockBuffer, 0).toLocaleString(), color: 'blue' }
                ].map((s, i) => (
                  <div key={i} className="bg-white p-6 rounded-[2.5rem] card-shadow border border-slate-100">
                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{s.label}</p>
                    <p className={`text-3xl font-black text-${s.color}-500 tracking-tighter`}>{s.val}</p>
                  </div>
                ))}
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white p-10 rounded-3xl card-shadow border border-slate-100 flex flex-col items-center justify-center min-h-[350px]">
                   <p className="text-6xl mb-6 opacity-20">üìä</p>
                   <p className="font-black text-slate-300 text-[10px] uppercase tracking-widest text-center">Real-time Fulfillment Metrics Synchronizing...</p>
                </div>
                <div className="bg-white p-10 rounded-3xl card-shadow border border-slate-100 min-h-[350px] space-y-6">
                  <h3 className="font-black italic text-slate-800 uppercase text-xs tracking-widest border-b pb-4">Recent Logistics Alerts</h3>
                  {INITIAL_ANNOUNCEMENTS.map(a => (
                    <div key={a.id} className="flex items-start gap-4 p-4 hover:bg-slate-50 rounded-2xl transition-all">
                      <span className="text-3xl">{a.icon}</span>
                      <div>
                        <p className="font-black text-sm text-slate-800">{a.title}</p>
                        <p className="text-[11px] text-slate-400 line-clamp-1">{a.detail}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        const InventoryView = ({ products, setProducts, notify }) => {
          return (
            <div className="space-y-8 animate-in">
              <div className="flex justify-between items-end">
                <h2 className="text-3xl font-black italic tracking-tighter">Master Inventory Hub</h2>
                <button className="px-8 py-4 bg-blue-600 text-white rounded-[2rem] font-black shadow-xl hover:scale-105 transition-all text-sm">+ Add Product</button>
              </div>
              <div className="bg-white rounded-[3rem] card-shadow border border-slate-100 overflow-hidden overflow-x-auto">
                <table className="w-full text-left font-bold min-w-[1000px]">
                  <thead className="bg-slate-900 text-slate-400 text-[9px] uppercase tracking-widest">
                    <tr>
                      <th className="p-8">Line Item / SKU</th>
                      <th className="p-8">Category</th>
                      <th className="p-8 bg-slate-800 text-blue-300 text-center">Purchasing</th>
                      <th className="p-8 text-pink-300 text-center">Influencer</th>
                      <th className="p-8 bg-slate-800 text-indigo-300 text-center">Affiliate</th>
                      <th className="p-8 text-emerald-300 text-center">Buffer Total</th>
                      <th className="p-8 text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y text-xs">
                    {products.map(p => (
                      <tr key={p.id} className="hover:bg-slate-50/50 transition-colors group">
                        <td className="p-8 flex items-center gap-6">
                          <div className="w-16 h-16 rounded-2xl product-img-container border border-slate-100 shadow-sm"><img src={p.images[0]} className="w-full h-full object-cover" /></div>
                          <div><p className="text-slate-900 font-black text-sm tracking-tight">{p.name}</p><p className="text-[10px] text-slate-300 uppercase font-black">{p.sku}</p></div>
                        </td>
                        <td className="p-8 font-black uppercase tracking-tighter text-slate-400">{p.category.split(' ')[0]}</td>
                        <td className="p-8 text-center text-xl font-black bg-slate-50/30 text-slate-700">{p.stockPurchasing}</td>
                        <td className="p-8 text-center text-xl font-black text-slate-700">{p.stockInfluencer}</td>
                        <td className="p-8 text-center text-xl font-black bg-slate-50/30 text-slate-700">{p.stockAffiliate}</td>
                        <td className="p-8 text-center text-xl font-black text-emerald-600 bg-emerald-50/20">{p.stockBuffer.toLocaleString()}</td>
                        <td className="p-8 text-center"><button className="text-blue-500 font-black hover:underline tracking-widest text-[10px] uppercase">Modify</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        const OperationsView = ({ view, orders, notify }) => {
          const source = view.toLowerCase().replace('_dep', '');
          const filtered = orders.filter(o => o.source === source);
          
          return (
            <div className="space-y-8 animate-in">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-black italic tracking-tighter uppercase">{view.replace('_DEP', '')} Management</h2>
                <button onClick={() => notify('Entry Log Initialized')} className="px-10 py-4 bg-slate-900 text-white rounded-3xl font-black shadow-2xl hover:scale-105 transition-all text-xs tracking-widest uppercase">Create Log</button>
              </div>
              <div className="bg-white rounded-[3rem] card-shadow border border-slate-100 overflow-hidden overflow-x-auto">
                <table className="w-full text-left font-bold min-w-[1000px]">
                  <thead className="bg-slate-900 text-slate-400 text-[9px] uppercase tracking-widest">
                    <tr>
                      <th className="p-8">PO Ref / ID</th>
                      <th className="p-8">Target Entity</th>
                      <th className="p-8">Product Items</th>
                      <th className="p-8 text-center">Status</th>
                      <th className="p-8 text-right">Value (‡∏ø)</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y text-xs">
                    {filtered.map(o => (
                      <tr key={o.id} className="hover:bg-slate-50/50 transition-colors">
                        <td className="p-8"><p className="text-slate-900 font-black text-sm">{o.poNumber}</p><p className="text-[9px] text-slate-300 font-black tracking-widest uppercase">{o.id}</p></td>
                        <td className="p-8 font-black text-slate-800">{o.targetName || '-'}</td>
                        <td className="p-8 space-y-1">
                          {o.items.map((it, idx) => <div key={idx} className="text-[10px] text-slate-500 font-black flex items-center gap-2"><span>‚Ä¢</span> {it.productName} (x{it.quantity})</div>)}
                        </td>
                        <td className="p-8 text-center"><span className={`status-pill ${o.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}`}>{o.status}</span></td>
                        <td className="p-8 text-right font-black text-slate-900 text-sm italic">‡∏ø{o.totalValue.toLocaleString()}</td>
                      </tr>
                    ))}
                    {filtered.length === 0 && <tr><td colSpan={5} className="p-32 text-center text-slate-300 font-black italic tracking-widest bg-white border border-dashed rounded-[3rem]">No Active Transactions Found</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        const WarehouseView = ({ orders, setOrders, setProducts, notify }) => {
          const pending = orders.filter(o => o.status === 'pending');
          
          const handleConfirm = (id) => {
            if (confirm('Verify dispatch and finalize stock deduction?')) {
              setOrders(prev => prev.map(o => {
                if (o.id === id) {
                  // Stock deduction simulation
                  o.items.forEach(item => {
                    setProducts(prods => prods.map(p => {
                      if (p.id === item.productId) {
                        const key = 'stock' + (o.source.charAt(0).toUpperCase() + o.source.slice(1));
                        return { ...p, [key]: Math.max(0, (p[key] || 0) - item.quantity) };
                      }
                      return p;
                    }));
                  });
                  return { ...o, status: 'confirmed', processedAt: new Date().toISOString() };
                }
                return o;
              }));
              notify('Order confirmed and inventory adjusted.');
            }
          };

          return (
            <div className="space-y-8 animate-in">
              <h2 className="text-3xl font-black italic tracking-tighter">Warehouse Fulfillment Pipeline</h2>
              <div className="grid grid-cols-1 gap-8">
                {pending.map(o => (
                  <div key={o.id} className="bg-white p-10 rounded-[3.5rem] card-shadow border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-10 hover:scale-[1.01] transition-all">
                    <div className="flex-1 space-y-4">
                      <div className="flex items-center gap-4">
                         <span className="bg-slate-900 text-white text-[9px] px-4 py-1.5 rounded-full font-black uppercase tracking-[0.2em]">{o.source}</span>
                         <h4 className="font-black text-2xl italic tracking-tight text-slate-800">{o.poNumber}</h4>
                      </div>
                      <p className="text-sm font-black text-slate-400 uppercase tracking-widest">Entity: <span className="text-slate-700">{o.targetName}</span></p>
                      <div className="flex flex-wrap gap-2 pt-2">
                        {o.items.map((i, idx) => (
                          <span key={idx} className="bg-slate-50 border border-slate-100 px-4 py-1.5 rounded-2xl text-[10px] font-black text-slate-500 shadow-sm">
                            {i.productName} (x{i.quantity})
                          </span>
                        ))}
                      </div>
                    </div>
                    <div className="flex items-center gap-10 bg-slate-50/50 p-6 rounded-[2.5rem] border border-slate-100">
                      <div className="text-right">
                        <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Logistics Value</p>
                        <p className="text-2xl font-black italic text-slate-900 tracking-tighter">‡∏ø{o.totalValue.toLocaleString()}</p>
                      </div>
                      <button onClick={() => handleConfirm(o.id)} className="bg-emerald-600 text-white px-12 py-5 rounded-3xl font-black shadow-2xl shadow-emerald-100 hover:scale-105 transition-all text-xs tracking-widest uppercase">Verify & Confirm</button>
                    </div>
                  </div>
                ))}
                {pending.length === 0 && <div className="p-32 text-center text-slate-300 font-black italic tracking-widest bg-white border border-dashed border-slate-200 rounded-[3rem]">No Orders Awaiting Dispatch</div>}
              </div>
            </div>
          );
        };

        const AiChatView = ({ products, orders }) => {
          const [msgs, setMsgs] = React.useState([{ role: 'model', text: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ LAGLACE AI Analyst ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?' }]);
          const [input, setInput] = React.useState('');
          const [load, setLoad] = React.useState(false);

          const send = async (e) => {
            e.preventDefault();
            if (!input.trim() || load) return;
            const uTxt = input; setInput(''); setMsgs(p => [...p, { role: 'user', text: uTxt }]); setLoad(true);
            try {
              const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
              const model = ai.models.generateContent({ 
                model: 'gemini-3-flash-preview', 
                contents: uTxt,
                config: { systemInstruction: `Analyst for LAGLACE. Data: Inventory:${JSON.stringify(products)}, History:${JSON.stringify(orders)}. Analyze risks and trends. Response in professional Thai.` }
              });
              const res = await model;
              setMsgs(p => [...p, { role: 'model', text: res.text || 'Cannot process request.' }]);
            } catch (e) { setMsgs(p => [...p, { role: 'model', text: 'Sync failed.' }]); }
            finally { setLoad(false); }
          };

          return (
            <div className="flex flex-col h-[calc(100vh-16rem)] max-w-5xl mx-auto bg-white rounded-[3rem] card-shadow border border-slate-100 overflow-hidden">
              <div className="flex-1 overflow-y-auto p-10 space-y-8 bg-slate-50/30">
                {msgs.map((m, i) => (
                  <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[80%] p-6 rounded-[2.5rem] text-sm font-medium shadow-sm leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-100 rounded-tl-none text-slate-700'}`}>{m.text}</div>
                  </div>
                ))}
                {load && <div className="text-[10px] text-indigo-400 font-black uppercase tracking-widest animate-pulse ml-6">Gemini is processing context...</div>}
              </div>
              <form onSubmit={send} className="p-8 bg-white border-t border-slate-100 flex gap-6">
                <input className="flex-1 p-5 bg-slate-50 border-none rounded-2xl outline-none font-black text-sm" placeholder="Ask Gemini AI to analyze stock risks or sales trends..." value={input} onChange={e => setInput(e.target.value)} />
                <button className="px-12 bg-indigo-600 text-white rounded-2xl font-black shadow-2xl shadow-indigo-100 text-xs tracking-widest uppercase">Analyze</button>
              </form>
            </div>
          );
        };

        // ==========================================
        // 3. MAIN APP
        // ==========================================

        const App = () => {
          const [isLoggedIn, setIsLoggedIn] = React.useState(false);
          const [currentUser, setCurrentUser] = React.useState({ name: '‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê (Admin)', role: 'Warehouse' });
          const [activeView, setActiveView] = React.useState('DASHBOARD');
          const [products, setProducts] = React.useState(INITIAL_PRODUCTS);
          const [orders, setOrders] = React.useState(INITIAL_ORDERS);
          const { msg: notification, notify } = useNotification();

          if (!isLoggedIn) {
            return (
              <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 relative overflow-hidden">
                <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-pink-500 rounded-full blur-[120px] opacity-20 animate-pulse-slow"></div>
                <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-600 rounded-full blur-[120px] opacity-20 animate-pulse-slow"></div>
                <form onSubmit={(e) => {e.preventDefault(); setIsLoggedIn(true); notify('Authenticated Access Authorized');}} className="w-full max-w-md bg-white/10 backdrop-blur-3xl p-14 rounded-[4rem] border border-white/20 shadow-2xl space-y-10 relative z-10 animate-in">
                  <div className="text-center">
                    <h1 className="text-6xl font-black text-white italic tracking-tighter mb-2">LAGLACE</h1>
                    <p className="text-slate-400 text-[10px] font-black uppercase tracking-[0.4em] ml-2">Internal Operations Portal Access</p>
                  </div>
                  <div className="space-y-4">
                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-1">Identity</label><input className="w-full p-5 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:border-blue-500 font-black" defaultValue="admin@laglace.com" /></div>
                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-1">Keyphrase</label><input type="password" placeholder="PASSWORD" className="w-full p-5 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:border-blue-500 font-black" defaultValue="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                  </div>
                  <button type="submit" className="w-full py-5 bg-white text-slate-900 rounded-3xl font-black hover:bg-blue-600 hover:text-white transition-all shadow-2xl active:scale-95 uppercase tracking-widest text-xs">Authorize Entry</button>
                </form>
              </div>
            );
          }

          const pendingCount = orders.filter(o => o.status === 'pending').length;

          return (
            <div className="flex h-screen w-full overflow-hidden">
              <Sidebar 
                activeView={activeView} 
                setActiveView={setActiveView} 
                currentUser={currentUser} 
                onLogout={() => setIsLoggedIn(false)}
                pendingCount={pendingCount}
              />
              <main className="flex-1 overflow-y-auto relative h-full">
                <header className="h-24 glass-header flex items-center justify-between px-12 sticky top-0 z-30">
                  <div className="flex items-center gap-3">
                    <span className="text-slate-300 text-[10px] font-black uppercase tracking-widest">Master /</span>
                    <span className="text-lg font-black text-slate-800 uppercase italic tracking-tighter">{activeView.replace('_DEP', '')}</span>
                  </div>
                  <div className="flex items-center gap-8">
                    <div className="hidden sm:block text-right">
                      <p className="text-xs font-black text-slate-900">{currentUser.name}</p>
                      <p className="text-[9px] text-emerald-500 font-black uppercase tracking-[0.2em]">Authorized Session</p>
                    </div>
                    <div className="w-12 h-12 rounded-3xl bg-blue-600 flex items-center justify-center text-white text-sm font-black shadow-2xl ring-4 ring-blue-50">P</div>
                  </div>
                </header>
                <div className="p-12 max-w-[1500px] mx-auto">
                   {activeView === 'DASHBOARD' && <DashboardView orders={orders} products={products} />}
                   {activeView === 'INVENTORY' && <InventoryView products={products} setProducts={setProducts} notify={notify} />}
                   {['PURCHASING', 'INFLUENCER_DEP', 'AFFILIATE_DEP', 'BUFFER_DEP'].includes(activeView) && <OperationsView view={activeView} orders={orders} notify={notify} />}
                   {activeView === 'WAREHOUSE' && <WarehouseView orders={orders} setOrders={setOrders} setProducts={setProducts} notify={notify} />}
                   {activeView === 'AI_CHAT' && <AiChatView products={products} orders={orders} />}
                </div>
              </main>

              {notification && (
                <div className="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-[2.5rem] font-black text-[10px] uppercase tracking-widest shadow-2xl animate-in slide-in-from-bottom-10 flex items-center gap-4 z-[100] border border-white/10">
                  <div className="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center text-[8px]">‚úì</div>
                  {notification}
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>